name: Publish to npm

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Download release binaries
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p staging
          gh release download "$GITHUB_REF_NAME" -D staging

      - name: Stage binaries into npm packages
        run: |
          # darwin-arm64
          cp staging/openpaw-darwin-arm64 npm/darwin-arm64/openpaw
          chmod +x npm/darwin-arm64/openpaw

          # darwin-x64
          cp staging/openpaw-darwin-x64 npm/darwin-x64/openpaw
          chmod +x npm/darwin-x64/openpaw

          # linux-x64
          cp staging/openpaw-linux-x64 npm/linux-x64/openpaw
          chmod +x npm/linux-x64/openpaw

          # linux-arm64
          cp staging/openpaw-linux-arm64 npm/linux-arm64/openpaw
          chmod +x npm/linux-arm64/openpaw

          # win32-x64
          cp staging/openpaw-win32-x64.exe npm/win32-x64/openpaw.exe

      - name: Update package versions
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          for pkg in npm/*/package.json; do
            node -e "
              const fs = require('fs');
              const p = JSON.parse(fs.readFileSync('$pkg', 'utf8'));
              p.version = '$VERSION';
              if (p.optionalDependencies) {
                for (const key of Object.keys(p.optionalDependencies)) {
                  p.optionalDependencies[key] = '$VERSION';
                }
              }
              fs.writeFileSync('$pkg', JSON.stringify(p, null, 2) + '\n');
            "
          done

      - name: Publish platform packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for pkg in darwin-arm64 darwin-x64 linux-x64 linux-arm64 win32-x64; do
            cd npm/$pkg
            npm publish --access public
            cd ../..
          done

      - name: Publish main package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd npm/openpaw
          npm publish --access public
